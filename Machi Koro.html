<!DOCTYPE html>
<html>

<head>
    <title>Machi Koro</title>

    <style>
        body {
            background-color: black;
            color: white;
        }

        button {
            font-size: 1em;
        }

        .title {
            text-align: center;
            font-weight: bold;
            font-size: 2em;
            border-bottom: 4px solid white;
        }

        .cards {
            display: flex;
        }

        .decks {
            font-size: 1.5em;
            border-bottom: 4px solid white;
            margin-bottom: 8px;
            padding-bottom: 8px;
        }

        .card {
            border: 2px solid white;
            margin: 2px;
            padding: 2px;
            background-color: grey;
            color: yellow;
            text-align: center;
            width: 100%;
        }

        .downCard {
            border: 2px solid white;
            margin: 2px;
            padding: 2px;
            background-color: grey;
            color: white;
            text-align: center;
            width: 100%;
        }

        .blue_card {
            border: 4px solid blue;
            margin: 2px;
            padding: 2px;
            background-color: grey;
            color: white;
            text-align: center;
            width: 100%;
        }

        .green_card {
            border: 4px solid green;
            margin: 2px;
            padding: 2px;
            background-color: grey;
            color: white;
            text-align: center;
            width: 100%;
        }

        .red_card {
            border: 4px solid red;
            margin: 2px;
            padding: 2px;
            background-color: grey;
            color: white;
            text-align: center;
            width: 100%;
        }

        .cardName {
            color: cyan;
        }

        .number {
            color: orange;
        }

        #currentPlayer {
            font-size: 1.5em;
            color: lime;
        }

        #selected {
            border-style: dotted;
            background-color: darkgrey;
        }

        #game {
            width: 85%;
        }

        #gameLog {
            width: 15%;
            border-right: 4px solid white;
            margin-right: 4px;
            padding-right: 4px;
            font-size: 1.25em;
        }
    </style>
</head>

<body>
    <div class='title'>
        Machi Koro
    </div>
    <div style="display: flex;">
        <div id='gameLog'></div>
        <div id='game'></div>
    </div>

    <script>
        var players = [];
        var turn = 0;
        var rolled = false;
        var extraTurn = false;
        var builtThisTurn = false;
        var diceChoices = [];
        var lastRoll = -1;
        var selected = -1;
        var gameLog = [];
        var sixOrLessDeck = {
            hidden: [],
            shown: []
        };
        var sevenOrMoreDeck = {
            hidden: [],
            shown: []
        };
        var purpleDeck = {
            hidden: [],
            shown: []
        };

        for (var i = 0; i < 6; i++) {
            sixOrLessDeck.hidden.push(new Establishment('Ranch', 'blue', [2], 1, 'Get 1 coin from the bank, on anyone\'s turn.', 'cow'));
            sixOrLessDeck.hidden.push(new Establishment('Flower Orchard', 'blue', [4], 2, 'Get 1 coin from the bank, on anyone\'s turn.', 'wheat'));
            sixOrLessDeck.hidden.push(new Establishment('Forest', 'blue', [5], 3, 'Get 1 coin from the bank, on anyone\'s turn.', 'gear'));
            sixOrLessDeck.hidden.push(new Establishment('Cafe', 'red', [3], 2, 'Get 1 coin from the player who rolled the dice.', 'cup'));
            sixOrLessDeck.hidden.push(new Establishment('General Store', 'green', [2], 0, 'If you have less than 2 constructed landmarks get 2 coins from the bank on your turn only.', 'bread'));
            sixOrLessDeck.hidden.push(new Establishment('Demolition Company', 'green', [4], 2, 'If possible, you must demolish one of your constructed landmarks by turning it back over to its unconstructed side. When you do, get 8 coins from the bank, on your turn only.', 'case'));
            sixOrLessDeck.hidden.push(new Establishment('Flower Shop', 'green', [6], 1, 'Get 1 coin from the bank for each flower orchard you own, on your turn only.', 'bread'));
            sixOrLessDeck.hidden.push(new Establishment('French Restaurant', 'red', [5], 3, 'If the player who rolled this number has 2 or more constructed landmarks, get 5 coins from the player who rolled the dice.', 'cup'));
            sixOrLessDeck.hidden.push(new Establishment('Wheat Field', 'blue', [1], 1, 'Get 1 coin from the bank, on anyone\'s turn.', 'wheat'));
            sixOrLessDeck.hidden.push(new Establishment('Sushi Bar', 'red', [1], 2, 'If you have a harbor, you get 3 coins from the player who rolled the dice.', 'cup'));
            sixOrLessDeck.hidden.push(new Establishment('Bakery', 'green', [2, 3], 1, 'Get 1 coin from the bank, on your turn only.', 'bread'));

            sevenOrMoreDeck.hidden.push(new Establishment('Tuna Boat', 'blue', [12, 13, 14], 5, 'On anyone\'s turn: The current player rolls 2 dice. If you have a harbor you get as many coins as the dice total.', 'boat'));
            sevenOrMoreDeck.hidden.push(new Establishment('Soda Bottling Plant', 'green', [11], 5, 'Get 1 coin from the bank for every &#x2615 owned by all players, on your turn only.', 'factory')); // Cup
            sevenOrMoreDeck.hidden.push(new Establishment('Cheese Factory', 'green', [7], 5, 'Get 3 coins from the bank for each &#x1F404 establishment that you own, on your turn only.', 'factory')); // Cow
            sevenOrMoreDeck.hidden.push(new Establishment('Furniture Factory', 'green', [8], 3, 'Get 3 coins from the bank for each &#x2699 establishment that you own, on your turn only.', 'factory')); // Gear
            sevenOrMoreDeck.hidden.push(new Establishment('Pizza Joint', 'red', [7], 1, 'Get 1 coin from the player who rolled the dice.', 'cup'));
            sevenOrMoreDeck.hidden.push(new Establishment('Member\'s Only Club', 'red', [12, 13, 14], 4, 'If the player who rolled this number has 3 or more constructed landmarks, get all of their coins.', 'cup'));
            sevenOrMoreDeck.hidden.push(new Establishment('Moving Company', 'green', [9, 10], 2, 'You must give a non-&#x1F3E2 building that you own to another player. When you do, get 4 coins from the bank, on your turn only', 'case')); // Office
            sevenOrMoreDeck.hidden.push(new Establishment('Mackerel Boat', 'blue', [8], 2, 'If you have a harbor, get 3 coins from the bank on anyone\'s turn.', 'boat'));
            sevenOrMoreDeck.hidden.push(new Establishment('Apple Orchard', 'blue', [10], 3, 'Get 3 coins from the bank, on anyone\'s turn.', 'wheat'));
            sevenOrMoreDeck.hidden.push(new Establishment('Fruit and Vegetable Market', 'green', [11, 12], 2, 'Get 2 coins from the bank for each &#x1F33E establishment you own, on your turn only.', 'apple')); // Wheat
            sevenOrMoreDeck.hidden.push(new Establishment('Family Restaurant', 'red', [9, 10], 3, 'Get 3 coins from the player who rolled the dice.', 'cup'));
        }

        startGame();

        function startGame() {
            var numOfPlayers = prompt("How many players will be playing?");

            for (var i = 0; i < numOfPlayers; i++) {
                var playerName = prompt("What is the name of player #" + (i + 1) + '?');
                if (playerName.indexOf('AI - ') == -1) {
                    players.push(new Player(playerName, false));
                } else {
                    players.push(new Player(playerName, true));
                }
            }

            while (sixOrLessDeck.shown.length < 5) {
                sixOrLessDeck.shown = sixOrLessDeck.shown.concat(takeRandomCardFromDeck(sixOrLessDeck.hidden));
            }

            while (sevenOrMoreDeck.shown.length < 5) {
                sevenOrMoreDeck.shown = sevenOrMoreDeck.shown.concat(takeRandomCardFromDeck(sevenOrMoreDeck.hidden));
            }

            gameLog.push('It is ' + currentPlayer().draw() + '\'s turn');

            draw();

            if (currentPlayer().AI) {
                rollWithDice(1);
            }
        }

        function takeRandomCardFromDeck(deck) {
            if (deck.length > 0) {
                var randomIndex = Math.floor(Math.random() * deck.length);
                return deck.splice(randomIndex, 1);
            } else {
                return [];
            }
        }

        function drawGameLog() {
            var t = '';
            for (var i = gameLog.length - 1; i >= 0; i--) {
                if (gameLog[i] != '<hr>') {
                    t += '- ' + gameLog[i] + '<br>';
                } else {
                    t += gameLog[i];
                }
            }
            document.getElementById('gameLog').innerHTML = t;
        }

        function draw() {
            var t = '';

            t += '<div class="decks">';
            t += '&#x2264 6:';
            t += '<div class="cards">';
            for (var i = 0; i < sixOrLessDeck.shown.length; i++) {
                var establishment = sixOrLessDeck.shown[i];
                t += establishment.draw(i);
            }
            t += '</div>';
            t += '&#x2265 7:';
            t += '<div class="cards">';
            for (var i = 0; i < sevenOrMoreDeck.shown.length; i++) {
                var establishment = sevenOrMoreDeck.shown[i];
                t += establishment.draw(i + sixOrLessDeck.shown.length);
            }
            t += '</div>';
            t += '</div>';

            var currentPlayerFirstPlayerOrder = getCurrentPlayerFirstPlayerOrder();

            for (var i = 0; i < currentPlayerFirstPlayerOrder.length; i++) {
                var player = currentPlayerFirstPlayerOrder[i];

                if (player == currentPlayer()) {
                    t += '<div id="currentPlayer">';
                    if (rolled) {
                        t += 'Rolled: ' + lastRoll + '<br>';
                        t += '<button onclick="nextTurn()">End Turn</button>';
                    } else if (diceChoices.length == 0) {
                        t += '<button onclick="rollWithDice(1)">ROLL 1 DIE</button>';
                        if (currentPlayer().hasLandmarkOfName('Train Station')) {
                            t += ' <button onclick="rollWithDice(2)">ROLL 2 DICE</button>';
                        }
                        if (currentPlayer().hasLandmarkOfName('Moon Tower')) {
                            t += ' <button onclick="rollWithDice(3)">ROLL 3 DICE</button>';
                        }
                    } else {
                        t += 'Pick your ROLL:<br>';
                        for (var j = 0; j < diceChoices.length; j++) {
                            t += '<button onclick="takeTurn(\'' + diceChoices[j] + '\')">' + diceChoices[j] + '</button> ';
                        }
                    }
                    t += '<br>';
                } else {
                    t += '<div>';
                }

                t += player.name + ': ' + player.coins + ' coins<br>';

                t += 'Landmarks:';
                t += '<div class="cards">';
                t += '<div class="card">City Hall<br>0<br><br><span>Immediately before buying establishments, if you have 0 coins, get 1 from the bank.</span></div>';
                for (var j = 0; j < player.landmarks.length; j++) {
                    var landmark = player.landmarks[j];
                    if (player == currentPlayer()) {
                        t += landmark.draw(sixOrLessDeck.shown.length + sevenOrMoreDeck.shown.length + purpleDeck.shown.length + j);
                    } else {
                        t += landmark.draw();
                    }
                }
                t += '</div>';

                t += 'Establishments:';
                t += '<div class="cards">';
                var lastEstablishmentName = '';
                var counter = 1;
                for (var j = 0; j < player.establishments.length; j++) {
                    var establishment = player.establishments[j];
                    if (lastEstablishmentName == establishment.name) {
                        counter++;
                    } else {
                        if (counter > 1) {
                            t += 'X' + counter;
                            counter = 1;
                        }
                        t += establishment.draw();
                    }
                    lastEstablishmentName = establishment.name;
                }
                if (counter > 1) {
                    t += 'X' + counter;
                }
                t += '</div>';

                t += '</div>';
                t += '<hr>';
            }

            document.getElementById('game').innerHTML = t;
            drawGameLog();
        }

        function getCopyOfAllPlayersCoins() {
            var coins = [];
            for (var i = 0; i < players.length; i++) {
                coins.push(players[i].coins);
            }
            return coins;
        }

        function logCoinChange(before, after) {
            for (var i = 0; i < before.length; i++) {
                var player = players[i];
                var before_coins = before[i];
                var after_coins = after[i];

                if (after_coins > before_coins) {
                    gameLog.push('' + player.draw() + ' gained <span class="number">' + (after_coins - before_coins) + '</span> coins!');
                } else if (after_coins < before_coins) {
                    gameLog.push('' + player.draw() + ' lost <span class="number">' + (before_coins - after_coins) + '</span> coins!');
                }
            }
        }

        function Player(name, AI) {
            this.name = name;
            this.AI = AI;
            this.color = 'rgb(' + Math.floor(Math.random() * 256) + ',' + Math.floor(Math.random() * 256) + ',' + Math.floor(Math.random() * 256) + ')';
            this.establishments = [
                new Establishment('Wheat Field', 'blue', [1], 1, 'Get 1 coin from the bank, on anyone\'s turn.', 'wheat'),
                new Establishment('Bakery', 'green', [2, 3], 1, 'Get 1 coin from the bank, on your turn only.', 'bread')
            ];
            this.coins = 0;
            this.landmarks = [
                new Landmark('Harbor', 2, false, 'If the dice total is 10 or more, you may add 2 to the total, on your turn only.'),
                new Landmark('Train Station', 4, false, 'You may roll 1 or 2 dice.'),
                new Landmark('Shopping Mall', 10, false, 'Each of your &#x2615 and &#x1F35E establishments earn +1 coin.'), // Cup & Bread
                new Landmark('Amusement Park', 16, false, 'If you roll doubles, take another turn after this one.'),
                new Landmark('Moon Tower', 22, false, 'You may roll three dice on your turn. If you do, remove one of the dice after rolling and only count the remaining two.'),
                new Landmark('Airport', 30, false, 'If you build nothing on your turn, you get 10 coins from the bank.'),
            ];

            this.draw = function () {
                return '<span style="color:' + this.color + ';">' + this.name + '</span>';
            }

            this.getNumberOfConstructedLandmarks = function () {
                var count = 0;
                for (var i = 0; i < this.landmarks.length; i++) {
                    if (this.landmarks[i].constructed) {
                        count++;
                    }
                }
                return count;
            };

            this.getNumberOfEstablishmentsOfName = function (name) {
                var count = 0;
                for (var i = 0; i < this.establishments.length; i++) {
                    if (this.establishments[i].name == name) {
                        count++;
                    }
                }
                return count;
            };

            this.getNumberOfEstablishmentsOfCategory = function (category) {
                var count = 0;
                for (var i = 0; i < this.establishments.length; i++) {
                    if (this.establishments[i].category == category) {
                        count++;
                    }
                }
                return count;
            };

            this.hasLandmarkOfName = function (name) {
                for (var i = 0; i < this.landmarks.length; i++) {
                    if (this.landmarks[i].name == name && this.landmarks[i].constructed) {
                        return true;
                    }
                }
                return false;
            };

            this.hasAllLandmarks = function () {
                return this.getNumberOfConstructedLandmarks() == this.landmarks.length;
            };

            this.sortEstablishments = function () {
                this.establishments.sort(function (a, b) {
                    return a.getAverageTrigger() - b.getAverageTrigger() || a.name.localeCompare(b.name);
                });
            };

            this.buyEstablishment = function (deck, index) {
                var establishment = deck.shown[index];
                if (rolled == false) {
                    gameLog.push('You have to roll before you can buy establishments!');
                } else if (establishment.cost <= this.coins) {
                    this.coins -= establishment.cost;
                    this.establishments.push(deck.shown.splice(index, 1)[0]);
                    deck.shown = deck.shown.concat(takeRandomCardFromDeck(deck.hidden));
                    this.sortEstablishments();
                    gameLog.push('' + this.draw() + ' bought the <span class="cardName">' + establishment.name + '</span>');
                    builtThisTurn = true;
                } else {
                    gameLog.push('' + this.draw() + ' doesn\'t have enough coins to buy the <span class="cardName">' + establishment.name + '</span>!');
                }
            };

            this.constructLandmark = function (index) {
                var landmark = this.landmarks[index];
                if (rolled == false) {
                    gameLog.push('You have to roll before you can construct landmarks!');
                } else if (landmark.constructed) {
                    gameLog.push('You\'ve already constructed the <span class="cardName">' + landmark.name + '</span>!');
                } else if (landmark.cost <= this.coins) {
                    this.coins -= landmark.cost;
                    landmark.constructed = true;
                    builtThisTurn = true;
                    gameLog.push('' + this.draw() + ' constructed the <span class="cardName">' + landmark.name + '</span>');

                    if (this.hasAllLandmarks()) {
                        winner();
                    }
                } else {
                    gameLog.push('' + this.draw() + ' doesn\'t have enough coins to construct the <span class="cardName">' + landmark.name + '</span>!');
                }
            };

            this.checkCardsOfType = function (type) {
                for (var i = 0; i < this.establishments.length; i++) {
                    var establishment = this.establishments[i];
                    if (type == establishment.type && establishment.triggers.indexOf(lastRoll) != -1 && ((establishment.type == 'blue') || (establishment.type == 'red' && this != currentPlayer()) || (establishment.type == 'green' && this == currentPlayer()))) {
                        this.activateCard(establishment);
                    }
                }
            };

            this.activateCard = function (establishment) {
                var conditionsMet = true;
                var demolitionCardActivated = false;
                var movingCompanyCardActivated = false;

                var before_allPlayersCoins = getCopyOfAllPlayersCoins();

                if (establishment.name == 'Wheat Field') {
                    this.coins += 1;
                } else if (establishment.name == 'Bakery') {
                    this.coins += 1;
                } else if (establishment.name == 'Ranch') {
                    this.coins += 1;
                } else if (establishment.name == 'Flower Orchard') {
                    this.coins += 1;
                } else if (establishment.name == 'Forest') {
                    this.coins += 1;
                } else if (establishment.name == 'Cafe') {
                    if (currentPlayer().coins >= 1) {
                        currentPlayer().coins -= 1;
                        this.coins += 1;
                    }
                } else if (establishment.name == 'General Store') {
                    if (this.getNumberOfConstructedLandmarks() < 2) {
                        this.coins += 2;
                    } else {
                        conditionsMet = false;
                    }
                } else if (establishment.name == 'Demolition Company') {
                    if (this.getNumberOfConstructedLandmarks() >= 1) {
                        demolitionCardActivated = true;
                    } else {
                        conditionsMet = false;
                    }
                } else if (establishment.name == 'Flower Shop') {
                    this.coins += 1 * this.getNumberOfEstablishmentsOfName('Flower Orchard');
                } else if (establishment.name == 'French Restaurant') {
                    if (currentPlayer().getNumberOfConstructedLandmarks() >= 2) {
                        if (currentPlayer().coins >= 5) {
                            currentPlayer().coins -= 5;
                            this.coins += 5;
                        } else {
                            this.coins += currentPlayer().coins;
                            currentPlayer().coins = 0;
                        }
                    } else {
                        conditionsMet = false;
                    }
                } else if (establishment.name == 'Sushi Bar') {
                    if (this.hasLandmarkOfName('Harbor')) {
                        if (currentPlayer().coins >= 3) {
                            currentPlayer().coins -= 3;
                            this.coins += 3;
                        } else {
                            this.coins += currentPlayer().coins;
                            currentPlayer().coins = 0;
                        }
                    } else {
                        conditionsMet = false;
                    }
                } else if (establishment.name == 'Tuna Boat') {
                    if (this.hasLandmarkOfName('Harbor')) {
                        this.coins += roll() + roll();
                    } else {
                        conditionsMet = false;
                    }
                } else if (establishment.name == 'Soda Bottling Plant') {
                    for (var i = 0; i < players.length; i++) {
                        this.coins += 1 * players[i].getNumberOfEstablishmentsOfCategory('cup');
                    }
                } else if (establishment.name == 'Cheese Factory') {
                    this.coins += 3 * this.getNumberOfEstablishmentsOfCategory('cow');
                } else if (establishment.name == 'Furniture Factory') {
                    this.coins += 3 * this.getNumberOfEstablishmentsOfCategory('gear');
                } else if (establishment.name == 'Pizza Joint') {
                    if (currentPlayer().coins >= 1) {
                        currentPlayer().coins -= 1;
                        this.coins += 1;
                    }
                } else if (establishment.name == 'Member\'s Only Club') {
                    if (currentPlayer().getNumberOfConstructedLandmarks() >= 3) {
                        this.coins += currentPlayer().coins;
                        currentPlayer().coins = 0;
                    } else {
                        conditionsMet = false;
                    }
                } else if (establishment.name == 'Mackerel Boat') {
                    if (this.hasLandmarkOfName('Harbor')) {
                        this.coins += 3;
                    } else {
                        conditionsMet = false;
                    }
                } else if (establishment.name == 'Apple Orchard') {
                    this.coins += 3;
                } else if (establishment.name == 'Fruit and Vegetable Market') {
                    this.coins += 2 * this.getNumberOfEstablishmentsOfCategory('wheat');
                } else if (establishment.name == 'Family Restaurant') {
                    if (currentPlayer().coins >= 3) {
                        currentPlayer().coins -= 3;
                        this.coins += 3;
                    } else {
                        this.coins += currentPlayer().coins;
                        currentPlayer().coins = 0;
                    }
                } else if (establishment.name == 'Moving Company') {
                    if (this.establishments.length >= 1) {
                        movingCompanyCardActivated = true;
                    } else {
                        conditionsMet = false;
                    }
                }

                if (conditionsMet) {
                    gameLog.push('' + this.draw() + '\'s <span class="cardName">' + establishment.name + '</span> was activated!');

                    if (demolitionCardActivated) {
                        demolitionCard(this);
                    } else if (movingCompanyCardActivated) {
                        movingCompanyCard(this);
                    }

                    if ((establishment.category == 'cup' || establishment.category == 'bread') && this.hasLandmarkOfName('Shopping Mall')) {
                        gameLog.push('Because of ' + this.draw() + '\'s <span class="cardName">Shopping Mall</span>, the <span class="cardName">' + establishment.name + '</span> gained <span class="number">1</span> extra coin!');
                        this.coins += 1;
                    }
                } else {
                    gameLog.push('The condtions for ' + this.draw() + '\'s <span class="cardName">' + establishment.name + '</span> were not met for it to activate');
                }

                var after_allPlayersCoins = getCopyOfAllPlayersCoins();

                logCoinChange(before_allPlayersCoins, after_allPlayersCoins);
            };
        }

        function winner() {
            alert('WE HAVE A WINNER!\n\nBecause ' + currentPlayer().name + ' constructed all the landmarks, they won the game!\n\nCONGRATULATION: ' + currentPlayer().name + '!!');

            if (players.length > 1) {
                players.splice(turn, 1);
                turn = turn % players.length;
            }
        }

        function demolitionCard(player) {
            var promptText = player.name + ' rolled a 4!\n\nYou must demolish a landmark!\nType the number corresponding to the landmark you wish to destroy:\n\n';

            var choices = []
            for (var i = 0; i < player.landmarks.length; i++) {
                if (player.landmarks[i].constructed) {
                    promptText += (i + 1) + ': ' + player.landmarks[i].name + '\n';
                    choices.push(i);
                }
            }

            var choice = '';

            if (player.AI) {
                choice = String(choices[0] + 1);
            }

            while (isNaN(choice) || choices.indexOf(parseInt(choice) - 1) == -1) {
                choice = prompt(promptText);

                if (isNaN(choice)) {
                    alert(choice + ' is not a number! You must enter a number!');
                } else if (choices.indexOf(parseInt(choice) - 1) == -1) {
                    alert(choice + ' is not a one of the valid options! You must pick one of the options shown!');
                }
            }
            choice = parseInt(choice) - 1;

            player.landmarks[choice].constructed = false;

            player.coins += 8;

            gameLog.push(player.draw() + ' demolished their <span class="cardName">' + player.landmarks[choice].name + '</span>!');
        }

        function movingCompanyCard(player) {
            var establishment = pickEstablishment(player);
            var sellToPlayer = pickPlayer(player, establishment);

            var establishmentIndex = player.establishments.indexOf(establishment);
            player.establishments.splice(establishmentIndex, 1);

            sellToPlayer.establishments.push(establishment);
            sellToPlayer.sortEstablishments();

            player.coins += 4;

            gameLog.push(player.draw() + ' sold their <span class="cardName">' + establishment.name + '</span> to ' + sellToPlayer.draw() + '!');
        }

        function pickEstablishment(player) {
            var promptText = player.name + ' rolled a 9 or 10!\n\nYou must sell an establishment to another player!\nType the number corresponding to the establishment you wish to sell:\n\n';

            var choices = []
            for (var i = 0; i < player.establishments.length; i++) {
                if (player.establishments[i].type != 'purple') {
                    promptText += (i + 1) + ': ' + player.establishments[i].name + '\n';
                    choices.push(i);
                }
            }

            var choice = '';

            if (player.AI) {
                choice = String(choices[Math.floor(Math.random() * choices.length)] + 1);
            }

            while (isNaN(choice) || choices.indexOf(parseInt(choice) - 1) == -1) {
                choice = prompt(promptText);

                if (isNaN(choice)) {
                    alert(choice + ' is not a number! You must enter a number!');
                } else if (choices.indexOf(parseInt(choice) - 1) == -1) {
                    alert(choice + ' is not a one of the valid options! You must pick one of the options shown!');
                }
            }
            choice = parseInt(choice) - 1;

            return player.establishments[choice];
        }

        function pickPlayer(player, establishment) {
            var promptText = 'To whom should the ' + establishment.name + ' be sold to?\n\nType the number corresponding to the player you wish to sell to:\n\n';

            var choices = []
            for (var i = 0; i < players.length; i++) {
                if (players[i] != player) {
                    promptText += (i + 1) + ': ' + players[i].name + '\n';
                    choices.push(i);
                }
            }

            var choice = '';

            if (player.AI) {
                choice = String(choices[Math.floor(Math.random() * choices.length)] + 1);
            }

            while (isNaN(choice) || choices.indexOf(parseInt(choice) - 1) == -1) {
                choice = prompt(promptText);

                if (isNaN(choice)) {
                    alert(choice + ' is not a number! You must enter a number!');
                } else if (choices.indexOf(parseInt(choice) - 1) == -1) {
                    alert(choice + ' is not a one of the valid options! You must pick one of the options shown!');
                }
            }
            choice = parseInt(choice) - 1;

            return players[choice];
        }

        function Landmark(name, cost, constructed, info) {
            this.name = name;
            this.cost = cost;
            this.constructed = constructed;
            this.info = info;

            this.draw = function (id) {
                var t = '';

                if (this.constructed) {
                    t += '<div class="card"';
                } else {
                    t += '<div class="downCard"';
                }

                if (id != undefined) {
                    t += ' onclick="select(' + id + ')"';

                    if (id == selected) {
                        t += ' id="selected"';
                    }
                }

                t += '>';

                t += this.name;
                t += '<br>';
                t += this.cost;
                t += '<br><br>';
                t += this.info;

                t += '</div>';

                return t;
            };
        }

        function Establishment(name, type, triggers, cost, info, category) {
            this.name = name;
            this.type = type;
            this.triggers = triggers;
            this.cost = cost;
            this.info = info;
            this.category = category;

            this.getAverageTrigger = function () {
                var sum = 0;
                for (var i = 0; i < this.triggers.length; i++) {
                    sum += triggers[i];
                }
                return sum / triggers.length;
            };

            this.draw = function (id) {
                var t = '';

                if (this.type == 'blue') {
                    t += '<div class="blue_card"';
                } else if (this.type == 'green') {
                    t += '<div class="green_card"';
                } else if (this.type == 'red') {
                    t += '<div class="red_card"';
                }

                if (id != undefined) {
                    t += ' onclick="select(' + id + ')"';

                    if (id == selected) {
                        t += ' id="selected"';
                    }
                }

                t += '>';

                t += '<span style="font-weight: bold";>' + this.name + '</span>';

                if (this.category == 'bread') {
                    t += ' &#x1F35E';
                } else if (this.category == 'wheat') {
                    t += ' &#x1F33E';
                } else if (this.category == 'cow') {
                    t += ' &#x1F404';
                } else if (this.category == 'cup') {
                    t += ' &#x2615';
                } else if (this.category == 'gear') {
                    t += ' &#x2699';
                } else if (this.category == 'case') {
                    t += ' &#x1F4BC';
                } else if (this.category == 'boat') {
                    t += ' &#x26F5';
                } else if (this.category == 'factory') {
                    t += ' &#x1F3ED';
                } else if (this.category == 'apple') {
                    t += ' &#x1F34E';
                }
                t += '<br>';
                t += 'Trigger: ';
                if (this.triggers.length > 1) {
                    t += this.triggers[0] + ' - ' + this.triggers[this.triggers.length - 1];
                } else {
                    t += this.triggers[0];
                }
                t += '<br>';
                t += 'Cost: ' + this.cost;
                t += '<br><br>';
                t += this.info;

                t += '</div>';

                return t;
            }
        }

        function select(id) {
            if (selected == id) {
                if (id < sixOrLessDeck.shown.length) {
                    currentPlayer().buyEstablishment(sixOrLessDeck, id);
                } else if (id < sixOrLessDeck.shown.length + sevenOrMoreDeck.shown.length) {
                    currentPlayer().buyEstablishment(sevenOrMoreDeck, id - sixOrLessDeck.shown.length);
                } else if (id < sixOrLessDeck.shown.length + sevenOrMoreDeck.shown.length + purpleDeck.shown.length) {
                    currentPlayer().buyEstablishment(purpleDeck, id - sixOrLessDeck.shown.length - sevenOrMoreDeck.shown.length);
                } else {
                    currentPlayer().constructLandmark(id - sixOrLessDeck.shown.length - sevenOrMoreDeck.shown.length - purpleDeck.shown.length);
                }
                selected = -1;
            } else {
                selected = id;
            }
            draw();
        }

        function takeTurn(diceRoll) {
            var diceRollSplit = String(diceRoll).split(' - ');

            if (diceRollSplit.length > 1) {
                diceRoll = diceRollSplit[0];
                gameLog.push('' + currentPlayer().draw() + ' rolled doubles! Because of the <span class="cardName">Amusement Park</span> they get an extra turn!');
                extraTurn = true;
            }

            lastRoll = parseInt(String(diceRoll));
            rolled = true;

            gameLog.push(currentPlayer().draw() + ' rolled a <span class="number">' + lastRoll + '</span>');

            var cardTypeOrder = ['red', 'blue', 'green', 'purple'];
            var reversePlayerOrder = getReversePlayerOrder();

            var before_allPlayersCoins = getCopyOfAllPlayersCoins();

            for (var i = 0; i < cardTypeOrder.length; i++) {
                var type = cardTypeOrder[i];
                for (var j = 0; j < reversePlayerOrder.length; j++) {
                    var player = reversePlayerOrder[j];
                    player.checkCardsOfType(type);
                }
            }

            if (currentPlayer().coins == 0) {
                currentPlayer().coins += 1;
                gameLog.push('Because ' + currentPlayer().draw() + ' has no coins, they earn <span class="number">1</span> coin from the <span class="cardName">City Hall</span>');
            }

            var after_allPlayersCoins = getCopyOfAllPlayersCoins();
            gameLog.push('<hr>');
            logCoinChange(before_allPlayersCoins, after_allPlayersCoins);
            gameLog.push('Summary of coin change:');

            draw();

            if (currentPlayer().AI) {
                buyBestStuff();
                nextTurn();
            }
        }

        function buyBestStuff() {
            var establishmentsInBestOrder = sixOrLessDeck.shown.concat(sevenOrMoreDeck.shown);

            establishmentsInBestOrder.sort(function (a, b) {
                return a.cost - b.cost || a.type.localeCompare(b.type);
            });

            while (establishmentsInBestOrder.length > 0 && establishmentsInBestOrder[0].cost <= currentPlayer().coins) {
                var establishment = establishmentsInBestOrder[0];

                var index = sixOrLessDeck.shown.indexOf(establishment);

                if (index == -1) {
                    buyBestLandmarks();
                }

                if (establishmentsInBestOrder[0].cost <= currentPlayer().coins) {
                    if (index != -1) {
                        currentPlayer().buyEstablishment(sixOrLessDeck, index);
                    } else {
                        index = sevenOrMoreDeck.shown.indexOf(establishment);
                        currentPlayer().buyEstablishment(sevenOrMoreDeck, index);
                    }
                }

                establishmentsInBestOrder = sixOrLessDeck.shown.concat(sevenOrMoreDeck.shown);
                establishmentsInBestOrder.sort(function (a, b) {
                    return a.cost - b.cost || a.type.localeCompare(b.type);
                });
            }

            buyBestLandmarks();
        }

        function buyBestLandmarks() {
            for (var i = 0; i < currentPlayer().landmarks.length; i++) {
                if (currentPlayer().landmarks[i].constructed == false && currentPlayer().landmarks[i].cost <= currentPlayer().coins) {
                    currentPlayer().constructLandmark(i);
                }
            }
        }

        function rollWithDice(dice) {
            updateDiceChoices(dice);

            if (diceChoices.length == 1) {
                takeTurn(diceChoices[0]);
            } else {
                draw();

                if (currentPlayer().AI) {
                    pickBestDiceChoice();
                }
            }
        }

        function pickBestDiceChoice() {
            takeTurn(diceChoices[Math.floor(Math.random() * diceChoices.length)]);
        }

        function updateDiceChoices(dice) {
            diceChoices = [];

            if (dice == 1) {
                diceChoices.push(roll());
            } else if (dice == 2) {
                var a = roll();
                var b = roll();

                diceChoices.push(a + b);

                if (a == b && currentPlayer().hasLandmarkOfName('Amusement Park')) {
                    gameLog.push('' + currentPlayer().draw() + ' rolled doubles! Because of the <span class="cardName">Amusement Park</span> they get an extra turn!');
                    extraTurn = true;
                }

                if (a + b >= 10 && currentPlayer().hasLandmarkOfName('Harbor')) {
                    gameLog.push('' + currentPlayer().draw() + ' rolled a 10 or higher! Because of the <span class="cardName">Harbor</span> they can add 2 to the dice roll!');
                    diceChoices.push(a + b + 2);
                }
            } else if (dice == 3) {
                var a = roll();
                var b = roll();
                var c = roll();

                var hasAmusementPark = currentPlayer().hasLandmarkOfName('Amusement Park');
                var hasHarbor = currentPlayer().hasLandmarkOfName('Harbor');

                if (a == b && hasAmusementPark) {
                    diceChoices.push(a + b + ' - DOUBLES!');
                } else {
                    diceChoices.push(a + b);
                }
                if (a + b >= 10 && hasHarbor) {
                    gameLog.push('' + currentPlayer().draw() + ' rolled a 10 or higher! Because of the <span class="cardName">Harbor</span> they can add 2 to the dice roll!');
                    if (a == b && hasAmusementPark) {
                        diceChoices.push(a + b + 2 + ' - DOUBLES!');
                    } else {
                        diceChoices.push(a + b + 2);
                    }
                }

                if (a == c && hasAmusementPark) {
                    diceChoices.push(a + c + ' - DOUBLES!');
                } else {
                    diceChoices.push(a + c);
                }
                if (a + c >= 10 && hasHarbor) {
                    gameLog.push('' + currentPlayer().draw() + ' rolled a 10 or higher! Because of the <span class="cardName">Harbor</span> they can add 2 to the dice roll!');
                    if (a == c && hasAmusementPark) {
                        diceChoices.push(a + c + 2 + ' - DOUBLES!');
                    } else {
                        diceChoices.push(a + c + 2);
                    }
                }

                if (b == c && hasAmusementPark) {
                    diceChoices.push(b + c + ' - DOUBLES!');
                } else {
                    diceChoices.push(b + c);
                }
                if (b + c >= 10 && hasHarbor) {
                    gameLog.push('' + currentPlayer().draw() + ' rolled a 10 or higher! Because of the <span class="cardName">Harbor</span> they can add 2 to the dice roll!');
                    if (b == c && hasAmusementPark) {
                        diceChoices.push(b + c + 2 + ' - DOUBLES!');
                    } else {
                        diceChoices.push(b + c + 2);
                    }
                }
            }
        }

        function getReversePlayerOrder() {
            var order = [];

            var index = turn;

            do {
                index -= 1;
                if (index < 0) {
                    index = players.length - 1;
                }

                order.push(players[index]);
            } while (index != turn);

            return order;
        }

        function getCurrentPlayerFirstPlayerOrder() {
            var order = []

            order.push(currentPlayer());

            var i = (turn + 1) % players.length;
            while (i != turn) {
                order.push(players[i]);
                i = (i + 1) % players.length;
            }

            return order;
        }

        function roll() {
            return Math.floor(Math.random() * 6 + 1);
        }

        function nextTurn() {
            if (!builtThisTurn && currentPlayer().hasLandmarkOfName('Airport')) {
                currentPlayer().coins += 10;
                gameLog.push('Because ' + currentPlayer().draw() + ' didn\'t build on their turn and they have an <span class="cardName">Airport</span>, they get an extra <span class="number">10</span> coins!');
            }

            if (!extraTurn) {
                turn = (turn + 1) % players.length;
            }
            extraTurn = false;
            rolled = false;
            builtThisTurn = false;
            diceChoices = [];

            gameLog.push('<hr>');
            gameLog.push('It is ' + currentPlayer().draw() + '\'s turn');

            if (currentPlayer().hasLandmarkOfName('Train Station')) {
                gameLog.push('Because ' + currentPlayer().draw() + ' has the <span class="cardName">Train Station</span> they can roll with <span class="number">2</span> dice!');
            }
            if (currentPlayer().hasLandmarkOfName('Moon Tower')) {
                gameLog.push('Because ' + currentPlayer().draw() + ' has the <span class="cardName">Moon Tower</span> they can roll with <span class="number">3</span> dice!');
            }

            draw();

            if (currentPlayer().AI) {
                if (currentPlayer().hasLandmarkOfName('Moon Tower')) {
                    rollWithDice(3);
                } else if (currentPlayer().hasLandmarkOfName('Train Station')) {
                    rollWithDice(2);
                } else {
                    rollWithDice(1);
                }
            }
        }

        function currentPlayer() {
            return players[turn];
        }
    </script>
</body>